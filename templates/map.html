<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ gu }} ì˜ë¥˜ìˆ˜ê±°í•¨ ì§€ë„</title>
  <style>
    #map { height: 80vh; width: 100%; }
    #info-box {
      padding: 1rem;
      background: #f7f7f7;
      border-top: 1px solid #ccc;
      font-family: sans-serif;
    }
    textarea {
      width: 100%;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h2 style="text-align: center;">{{ gu }} ì˜ë¥˜ìˆ˜ê±°í•¨ ì§€ë„</h2>

  <!-- ğŸ” ì£¼ì†Œ ê²€ìƒ‰ì°½ -->
  <div style="text-align: center; margin: 10px;">
    <input type="text" id="search-input" placeholder="ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: ë…¸ëŸ‰ì§„)" style="width: 300px; padding: 5px;">
    <button onclick="searchAddress()">ê²€ìƒ‰</button>
  </div>

  <div id="map"></div>

  <div id="info-box">
    <h3 id="bin-title">ìˆ˜ê±°í•¨ ì •ë³´</h3>
    <p id="bin-address">ì£¼ì†Œ: </p>

    <form method="POST" action="/add-review">
      <input type="hidden" name="bin_id" id="bin-id-input">
      <input type="hidden" name="gu" value="{{ gu }}">
      <textarea name="content" rows="2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
      <button type="submit" style="margin-top: 6px;">ëŒ“ê¸€ ë“±ë¡</button>
    </form>

    <div id="review-list" style="margin-top: 1rem;">
      <strong>ğŸ’¬ í›„ê¸° ëª©ë¡</strong>
      <div id="reviews-container" style="margin-top: 4px;"></div>
    </div>
  </div>

  <script>
    const gu = "{{ gu }}";
    const isAdmin = "{{ 'true' if session.get('admin') else 'false' }}" === "true";

    let searchMarker = null;  // ğŸ”µ ê²€ìƒ‰ ë§ˆì»¤ëŠ” í•˜ë‚˜ë§Œ ìœ ì§€

    async function initMap() {
      const res = await fetch(`/bins?gu=${gu}`);
      const bins = await res.json();

      const center = bins.length > 0
        ? { lat: bins[0].lat, lng: bins[0].lng }
        : { lat: 37.5, lng: 127.0 };

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: center,
      });

      window.currentMap = map;

      bins.forEach(bin => {
        const marker = new google.maps.Marker({
          position: { lat: bin.lat, lng: bin.lng },
          map,
          title: bin.name
        });

        marker.addListener('click', async () => {
          document.getElementById('bin-title').textContent = bin.name;
          document.getElementById('bin-address').textContent = "ì£¼ì†Œ: " + bin.address;
          document.getElementById('bin-id-input').value = bin.id;

          const res = await fetch(`/reviews/${bin.id}`);
          const comments = await res.json();

          const container = document.getElementById('reviews-container');
          container.innerHTML = comments.length > 0
            ? comments.map(r => `
                <p>
                  ğŸ—¨ï¸ ${r.content}
                  <span style="color:gray; font-size:0.8em;">(${r.created_at})</span>
                  ${isAdmin ? `
                    <a href="/edit-review/${r.id}">âœï¸</a>
                    <a href="/delete-review/${r.id}?gu=${gu}" onclick="return confirm('ì‚­ì œí• ê¹Œìš”?')">âŒ</a>
                  ` : ''}
                </p>
              `).join('')
            : '<p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        });
      });

      // ğŸ“ GPS ìœ„ì¹˜ ë§ˆì»¤
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            new google.maps.Marker({
              position: userLocation,
              map,
              title: "ë‚´ ìœ„ì¹˜",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: '#4285F4',
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: 'white'
              }
            });

            map.setCenter(userLocation);
          },
          () => {
            console.log("âš ï¸ ìœ„ì¹˜ ì •ë³´ í—ˆìš© ì•ˆ ë¨");
          }
        );
      }
    }

    // ğŸ” ì£¼ì†Œ ê²€ìƒ‰ ê¸°ëŠ¥ (íŒŒë€ ë§ˆì»¤, í•˜ë‚˜ë§Œ ìœ ì§€)
    function searchAddress() {
      const input = document.getElementById("search-input").value;
      if (!input) return;

      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: input }, (results, status) => {
        if (status === "OK") {
          const location = results[0].geometry.location;
          const map = window.currentMap;

          map.setCenter(location);
          map.setZoom(15);

          // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
          if (searchMarker) {
            searchMarker.setMap(null);
          }

          // ìƒˆë¡œìš´ íŒŒë€ ë§ˆì»¤ ì¶”ê°€
          searchMarker = new google.maps.Marker({
            position: location,
            map,
            title: input,
            icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'  // ğŸ”µ íŒŒë€ìƒ‰ ë§ˆì»¤
          });
        } else {
          alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + status);
        }
      });
    }
  </script>

  <!-- âœ… API í‚¤ ë„£ê¸° -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHmMxsmDeGtL6VLI5a34USu1jDCLqPnbo&callback=initMap" async defer></script>
</body>
</html>