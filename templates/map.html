<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>{{ gu }} ì˜ë¥˜ìˆ˜ê±°í•¨ ì§€ë„</title>
  <style>
    #map {
      width: 100%;
      height: 500px;
    }
    #bin-info {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>{{ gu }} ì˜ë¥˜ìˆ˜ê±°í•¨ ì§€ë„</h2>
  <div id="map"></div>

  <div id="bin-info">
    <h3 id="bin-title">ìˆ˜ê±°í•¨ ì •ë³´</h3>
    <p id="bin-address">ì£¼ì†Œ: </p>

    <form action="/add-review" method="POST">
      <input type="hidden" id="bin-id-input" name="bin_id">
      <input type="hidden" name="gu" value="{{ gu }}">
      <input type="text" name="content" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required>
      <button type="submit">ì‘ì„±</button>
    </form>

    <div id="reviews">
      <h4>ëŒ“ê¸€ ëª©ë¡</h4>
      <ul id="review-list"></ul>
    </div>
  </div>

  <script>
    let map;
    let reviewList = document.getElementById('review-list');

    function initMap() {
      const centerGu = {
        'ê°•ë‚¨êµ¬': { lat: 37.5172, lng: 127.0473 },
        'ì„œì´ˆêµ¬': { lat: 37.4837, lng: 127.0327 },
        'ë™ì‘êµ¬': { lat: 37.5124, lng: 126.9390 },
        'ê´€ì•…êµ¬': { lat: 37.4784, lng: 126.9516 }
      };

      const gu = "{{ gu }}";
      const center = centerGu[gu] || { lat: 37.5665, lng: 126.9780 };

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: center,
      });

      fetch(`/bins?gu=${gu}`)
        .then(response => response.json())
        .then(data => {
          data.forEach(bin => {
            const marker = new google.maps.Marker({
              position: { lat: bin.lat, lng: bin.lng },
              map,
              title: bin.name
            });

            marker.addListener('click', () => {
              document.getElementById('bin-title').textContent = bin.name;
              document.getElementById('bin-address').textContent = "ì£¼ì†Œ: " + bin.address;
              document.getElementById('bin-id-input').value = bin.id;

              // ëŒ“ê¸€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
              fetch(`/reviews?bin_id=${bin.id}`)
                .then(res => res.json())
                .then(reviews => {
                  reviewList.innerHTML = '';
                  reviews.forEach(r => {
                    const li = document.createElement('li');
                    li.textContent = `${r.content} (${r.created_at})`;
                    reviewList.appendChild(li);
                  });
                });
            });
          });
        });

      // âœ… í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const userPos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          new google.maps.Marker({
            position: userPos,
            map,
            title: "ë‚´ ìœ„ì¹˜",
            icon: {
              url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            }
          });
        });
      }

      // âœ… ê²€ìƒ‰ ê¸°ëŠ¥
      const searchInput = document.createElement('input');
      searchInput.type = 'text';
      searchInput.placeholder = 'ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”';
      searchInput.style.marginTop = '10px';
      document.body.insertBefore(searchInput, document.getElementById('bin-info'));

      const searchButton = document.createElement('button');
      searchButton.textContent = 'ê²€ìƒ‰';
      document.body.insertBefore(searchButton, document.getElementById('bin-info'));

      let searchMarker = null;

      searchButton.addEventListener('click', () => {
        const address = searchInput.value;
        if (!address) return;
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: address }, (results, status) => {
          if (status === 'OK') {
            map.setCenter(results[0].geometry.location);
            if (searchMarker) searchMarker.setMap(null);
            searchMarker = new google.maps.Marker({
              map: map,
              position: results[0].geometry.location,
              icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            });
          } else {
            alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }
        });
      });
    }
  </script>

  <!-- ğŸ”‘ ë„ˆì˜ êµ¬ê¸€ Maps API í‚¤ë¥¼ ì—¬ê¸°ì—! -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHmMxsmDeGtL6VLI5a34USu1jDCLqPnbo&callback=initMap">
  </script>
</body>
</html>